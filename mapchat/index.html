<!DOCTYPE html>

<html>

<head>
	<title>MapChat</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="style.css" />	
	<script>
		var lat = 0;
		var lng = 0;
		var request = new XMLHttpRequest();
		var me = new google.maps.LatLng(lat, lng);
		var options = {
			zoom: 15, 
			center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map;
		var marker;
		var infoWindow = new google.maps.InfoWindow();
        var myLogin = "RichBiggerstaff";
        var myMessage = "Hello%20Everyone!";
        var data = "";
        var sendMessage;
        var people;
        var otherStudents = [];
        var studentInfo = [];
        var contentString;
		
        function haversine(lat1, lng1, lat2, lng2) {
            function toRad(x) {
                return x * Math.PI / 180;
            }

            var R = 6371; // km 
            //has a problem with the .toRad() method below.
            var x1 = lat2-lat1;
            var dLat = toRad(x1);  
            var x2 = lon2-lon1;
            var dLon = toRad(x2);  
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);  
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 

            return d;
        }


        function studentMarkers() {
            data = request.responseText;
                            
            console.log(data);

            ppl = JSON.parse(data);

            elem = document.getElementById("map_canvas");

            for (var i = 0; i < ppl.length; i++) {
                if (ppl[i].login != myLogin) {
                    otherStudents[i] = new google.maps.Marker({
                        position: new google.maps.LatLng(ppl[i].lat, 
                            ppl[i].lng),
                        title: ppl[i].message
                    });
                    
                    otherStudents[i].setMap(map);

                    console.log(ppl[i].message);

                    contentString = "<p>login:" + ppl[i].login + "</p><p>Message: " + ppl[i].message + "</p><p>Distance from me: " + haversine(otherStudents[i].position) + "</p>";

                    google.maps.event.addListener('click', function() {
                        studentInfo[i] = new google.maps.InfoWindow({
                            content: contentString
                        });
                        
                        studentInfo[i].setContent(otherStudents[i].title);
                    
                        studentInfo[i].open(map, otherStudents[i]);
                    });
                }
            }
        }


        function httpRequest() {
            request.onreadystatechange = function() {
                if (request.readyState == 4 && request.status == 200){
                    studentMarkers();        
                } 
            } 

            request.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);

            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");               

            sendMessage = "login=" + myLogin + "&lat=" + lat + "&lng=" + lng + "&message=" + myMessage;

            request.send(sendMessage);
        }

        function renderMap() {
            me = new google.maps.LatLng(lat, lng);

            // Update map and go there...
            map.panTo(me);
    
            // Create a marker
            marker = new google.maps.Marker({
                position: me,
                title: "Here I Am!"
            });

            marker.setMap(map);

            // Open info window on click of marker
            google.maps.event.addListener(marker, 'click', function() {
                infoWindow.setContent(marker.title);
                infoWindow.open(map, marker);
            });

            httpRequest();
        }

        function getMyLocation() {
            if (navigator.geolocation) { 
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        renderMap();
                    });
            } else {
                alert("Geolocation is not supported by your web browser");
            }
        }

		function init() {
            map = new google.maps.Map(document.getElementById("map_canvas"), options);
            getMyLocation();  
		}

	</script>
</head>
	
<body onload="init()">
	<div id="map_canvas"></div>
</body>

</html>