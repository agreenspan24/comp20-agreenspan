<!DOCTYPE html>

<html>
	<head>
		<title>MapChat</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
		<link rel="stylesheet" href="style.css" />
		
		<script>
			var lat = 0;
			var lng = 0;
			var request = new XMLHttpRequest();
			var me = new google.maps.LatLng(lat, lng);
			var options = {
						zoom: 13, 
						center: me,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};
			var map;
			var marker;
			var infoWindow = new google.maps.InfoWindow();
            var myLogin = "RichBiggerstaff";
            var myMessage = "Hello%20Everyone!";
            var data = "";
            var people;
			
            function httpRequest(){
                request.onreadystatechange = function(){
                while (readyState != 4)
                if (request.readyState == 4 && request.status == 200) {
                    if(request.responseText){
                        console.log(request.responseText);
                    }
                } else if (request.readyState == 4) {
                    console.log("status not 200");
                } else if (request.status == 200) {
                    console.log("readystate: " + request.readyState)
                } else {
                    console.log("neither");
                }
               }
               //console.log('4');

               request.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
               //console.log('2');

               request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                
               // console.log('3');
               

               var sendMessage = "login=" + myLogin + "&lat=" + lat + "&lng=" + lng + "&message=" + myMessage;

               request.send(sendMessage);

               if (request.responseText != 'undefined' && request.responseText != "")
                return request.responseText;
            }

            function renderMap()
            {
                me = new google.maps.LatLng(lat, lng);

                // Update map and go there...
                map.panTo(me);
    
                // Create a marker
                marker = new google.maps.Marker({
                    position: me,
                    title: "Here I Am!"
                });
                marker.setMap(map);

                data = httpRequest();

                console.log(data);

                ppl = JSON.parse(data);

                elem = document.getElementById("map_canvas");

                for (var i = 0; i < ppl.length; i++){
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(ppl[i].lat, ppl[i].lng),
                        title: ppl[i].message
                    });
                }
                    
                // Open info window on click of marker
                google.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent(marker.title);
                    infowindow.open(map, marker);
                });
            }

            function getMyLocation() {
                if (navigator.geolocation) { 
                    navigator.geolocation.getCurrentPosition(function(position) {
                        lat = position.coords.latitude;
                        lng = position.coords.longitude;
                        renderMap();
                    });
                }
                else {
                    alert("Geolocation is not supported by your web browser");
                }
            }

			function init() {
                map = new google.maps.Map(document.getElementById("map_canvas"), options);
                getMyLocation();  
			}
			




		</script>
	</head>
	
	<body onload="init()">
		<div id="map_canvas"></div>
	</body>
</html>