<!DOCTYPE html>

<html>
	<head>
		<title>MapChat</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
		<link rel="stylesheet" href="style.css" />
		
		<script>
			var lat = 0;
			var lng = 0;
			var request = new XMLHttpRequest();
			var me = new google.maps.LatLng(lat, lng);
			var options = {
						zoom: 13, 
						center: me,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};
			var map;
			var marker;
			var infoWindow = new google.maps.InfoWindow();
            var myLogin = "RichBiggerstaff";
            var myMessage = "Hello%20Everyone!";
            var data = "";
            var people;
			
			function init()
			{
				map = new google.maps.Map(document.getElementById("map_canvas"), options);
				getMyLocation();
			}
			
			function getMyLocation() {
				if (navigator.geolocation) { 
					navigator.geolocation.getCurrentPosition(function(position) {
						lat = position.coords.latitude;
						lng = position.coords.longitude;
						renderMap();
					});
				}
				else {
					alert("Geolocation is not supported by your web browser");
				}
			}
			function renderMap()
			{
				me = new google.maps.LatLng(lat, lng);

                // Update map and go there...
                map.panTo(me);
    
                // Create a marker
                marker = new google.maps.Marker({
                    position: me,
                    title: "Here I Am!"
                });
                marker.setMap(map);

                data = HTTPRequest();

                console.log(data);

                people = JSON.parse(data);

                elem = document.getElementById("map_canvas");

                for (var i = 0; i < people.length; i++){
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(people[i].lat, people[i].lng),
                        title: position[i].message
                    });
                }
					
				// Open info window on click of marker
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});
			}

			function HTTPRequest(){
                request.onreadystatechange = function(){
                if (request.readyState == 4 && request.status == 200) {
                    if(request.responseText){
                        console.log(request.responseText);
                    }
                } else if (request.readyState == 4) {
                    console.log("status not 200");
                } else if (request.status == 200) {
                    console.log("readystate: " + request.readyState)
                } else {
                    console.log("neither");
                }
               }
               //console.log('4');

	           request.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
               //console.log('2');

	           request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                
               // console.log('3');
               

	           var sendMessage = "login=" + myLogin + "&lat=" + lat + "&lng=" + lng + "&message=" + myMessage;

	           request.send(sendMessage);

               if (request.responseText != 'undefined')
                return request.responseText;
            }
		</script>
	</head>
	
	<body onload="init()">
		<div id="map_canvas"></div>
	</body>
</html>